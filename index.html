<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Calcolatore Multicanale Testo con Finestre</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f9; transition: background-color 0.3s;}
h1 { text-align:center; color:#333;}
.canale { background:#fff; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.subcanale { margin-bottom:10px;}
.subcanale textarea { width:200px; height:60px; resize:none; font-family:monospace; white-space:pre-wrap; word-wrap:break-word;}
button { margin:5px 2px; padding:5px 10px; cursor:pointer;}
table { width:100%; border-collapse:collapse; margin-top:30px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
th,td { border:1px solid #ccc; padding:8px; text-align:center;}
th { background:#eee; }
/* Menu a tendina */
#menuToggle { position: fixed; top:10px; right:10px; font-size:24px; cursor:pointer; background:#f1f1f1; border:1px solid #ccc; padding:5px 10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); z-index:1001;}
#menu { position: fixed; top:50px; right:10px; background:#f1f1f1; border:1px solid #ccc; padding:15px; width:320px; z-index:1000; border-radius:8px; max-height:600px; overflow-y:auto; opacity:0; transition:opacity 0.3s ease;}
#menu.show { opacity:1; }
#menu label { display:block; margin-top:10px; font-weight:bold; }
#menu select,#menu input,#menu button { margin-top:5px; width:100%; box-sizing:border-box; }
#menu button { padding:8px; }
.flash { background-color: yellow !important; transition: background-color 0.3s;}
#clock { font-weight:bold; font-size:18px; margin-bottom:10px; text-align:center; }
.window { margin:5px 0; }
</style>
</head>
<body>
<h1>üìã Calcolatore Multicanale Testo</h1>
<div id="clock">‚è∞ Ora: --:--:--</div>

<div id="canali"></div>

<div id="menuToggle">‚öôÔ∏è Menu</div>
<div id="menu">
  <label>Seleziona Canale</label>
  <select id="menuChannelSelect" onchange="updateSubSelect()"></select>
  <button onclick="menuAddChannel()">Aggiungi Canale</button>
  <button onclick="menuDeleteChannel()">Elimina Canale</button>
  <input type="color" id="menuColor" onchange="menuChangeColor(this.value)">
  
  <hr>
  <label>Seleziona Subcanale</label>
  <select id="menuSubSelect"></select>
  <button onclick="menuAddSub()">Aggiungi Subcanale</button>
  <button onclick="menuDeleteSub()">Elimina Subcanale</button>
  
  <hr>
  <label>Rinomina Canale</label>
  <input type="text" id="menuRenameChannel" placeholder="Nuovo nome canale">
  <button onclick="menuRenameChannel()">Applica</button>

  <label>Rinomina Subcanale</label>
  <input type="text" id="menuRenameSub" placeholder="Nuovo nome subcanale">
  <button onclick="menuRenameSub()">Applica</button>

  <hr>
  <label>Finestre Orarie</label>
  <input type="time" id="startTime">
  <input type="time" id="endTime">
  <button onclick="addWindow()">Aggiungi Finestra</button>
  <div id="windows"></div>

  <hr>
  <button onclick="clearStorici()">Elimina Tabella Storici</button>
  <button onclick="exportCSV()">Esporta CSV</button>
  <button onclick="exportExcel()">Esporta Excel</button>
</div>

<h2>Storici</h2>
<table id="storici">
  <thead>
    <tr id="headerStorici"><th>Orario</th></tr>
  </thead>
  <tbody></tbody>
</table>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<script>
let canali = [];
let windows = [];
let finestreProcessate = [];

// Aggiorna orologio live
function updateClock(){
  const now = new Date();
  document.getElementById("clock").textContent = "‚è∞ Ora: "+now.toLocaleTimeString();
}
setInterval(updateClock,1000);
updateClock();

// Toggle menu
document.getElementById("menuToggle").onclick = () => {
  document.getElementById("menu").classList.toggle("show");
}

// --- Funzioni Canali/Subcanali ---
function aggiungiCanale(nome="Canale"){
  const idCanale = canali.length+1;
  const canale = {id:idCanale,nome:nome+" "+idCanale,color:"#ffffff",subcanali:[]};
  canali.push(canale);
  const div = document.createElement('div');
  div.className='canale';
  div.id='canale_'+idCanale;
  div.style.backgroundColor = canale.color;
  div.innerHTML=`<h3>${canale.nome}</h3><div id="subcanali_${idCanale}"></div>`;
  document.getElementById('canali').appendChild(div);
  populateMenuChannel();
}

function aggiungiSubcanale(idCanale,nomeSub=null){
  const canale = canali.find(c=>c.id==idCanale);
  const idSub = canale.subcanali.length+1;
  const nome = nomeSub || prompt("Nome del Subcanale:") || "Sub "+idSub;
  canale.subcanali.push({id:idSub,nome});
  const div = document.createElement('div');
  div.className='subcanale';
  div.id=`subcanale_${idCanale}_${idSub}`;
  div.innerHTML=`<strong>${nome}:</strong><br><textarea id="input_${idCanale}_${idSub}" oninput="wrapText(this)" maxlength="200"></textarea>`;
  document.getElementById('subcanali_'+idCanale).appendChild(div);
  updateSubSelect();
  aggiornaHeaderStorici();
}

function wrapText(textarea){
  const val = textarea.value.replace(/\n/g,'');
  let result='';
  for(let i=0;i<val.length;i+=5){ result += val.substring(i,i+5)+"\n"; }
  textarea.value=result.trim();
}

// --- Menu ---
function populateMenuChannel(){
  const select=document.getElementById("menuChannelSelect");
  select.innerHTML="";
  canali.forEach((c,i)=>{ const opt=document.createElement("option"); opt.value=i; opt.text=c.nome; select.add(opt); });
  updateSubSelect();
}

function updateSubSelect(){
  const chIndex=document.getElementById("menuChannelSelect").value;
  const select=document.getElementById("menuSubSelect");
  select.innerHTML="";
  if(canali[chIndex]) canali[chIndex].subcanali.forEach((s,i)=>{ const opt=document.createElement("option"); opt.value=i; opt.text=s.nome; select.add(opt); });
}

function menuAddChannel(){ aggiungiCanale(); }
function menuDeleteChannel(){
  const chIndex=document.getElementById("menuChannelSelect").value;
  if(!canali[chIndex]) return;
  if(confirm(`Eliminare il canale "${canali[chIndex].nome}"?`)){
    document.getElementById('canale_'+canali[chIndex].id).remove();
    canali.splice(chIndex,1);
    populateMenuChannel(); aggiornaHeaderStorici();
  }
}

function menuAddSub(){
  const chIndex=document.getElementById("menuChannelSelect").value;
  if(!canali[chIndex]) return;
  aggiungiSubcanale(canali[chIndex].id);
}

function menuDeleteSub(){
  const chIndex=document.getElementById("menuChannelSelect").value;
  const subIndex=document.getElementById("menuSubSelect").value;
  if(!canali[chIndex]||!canali[chIndex].subcanali[subIndex]) return;
  const sub=canali[chIndex].subcanali[subIndex];
  document.getElementById(`subcanale_${canali[chIndex].id}_${sub.id}`).remove();
  canali[chIndex].subcanali.splice(subIndex,1);
  updateSubSelect();
  aggiornaHeaderStorici();
}

function menuRenameChannel(){
  const chIndex=document.getElementById("menuChannelSelect").value;
  const nome=document.getElementById("menuRenameChannel").value.trim();
  if(nome){
    canali[chIndex].nome=nome;
    document.querySelector('#canale_'+canali[chIndex].id+' h3').textContent=nome;
    populateMenuChannel();
  }
}

function menuRenameSub(){
  const chIndex=document.getElementById("menuChannelSelect").value;
  const subIndex=document.getElementById("menuSubSelect").value;
  const nome=document.getElementById("menuRenameSub").value.trim();
  if(nome){
    canali[chIndex].subcanali[subIndex].nome=nome;
    document.querySelector(`#subcanale_${canali[chIndex].id}_${canali[chIndex].subcanali[subIndex].id} strong`).textContent=nome+":";
    updateSubSelect(); aggiornaHeaderStorici();
  }
}

function menuChangeColor(col){
  const chIndex=document.getElementById("menuChannelSelect").value;
  canali[chIndex].color=col;
  document.getElementById('canale_'+canali[chIndex].id).style.backgroundColor=col;
}

// --- Finestre Orarie ---
function addWindow(){
  const start=document.getElementById("startTime").value;
  const end=document.getElementById("endTime").value;
  if(!start||!end) return alert("Orari non validi");
  windows.push({start,end});
  finestreProcessate.push(false);
  renderWindows();
}

function renderWindows(){
  const div=document.getElementById("windows");
  div.innerHTML="";
  windows.forEach((w,i)=>{
    const el=document.createElement("div");
    el.className="window";
    el.innerHTML=`üïí ${w.start} - ${w.end} <button onclick="removeWindow(${i})">Elimina</button>`;
    div.appendChild(el);
  });
}

function removeWindow(i){ 
  windows.splice(i,1); 
  finestreProcessate.splice(i,1);
  renderWindows(); 
}

// --- Storici ---
function aggiornaHeaderStorici(){
  const header=document.getElementById('headerStorici');
  header.innerHTML='<th>Orario</th>';
  canali.forEach(c=>c.subcanali.forEach(s=>{header.innerHTML+=`<th>${s.nome}</th>`;}));
}

function aggiornaStorici(){
  const now = new Date();
  const hhmm = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

  windows.forEach((w, index) => {
    if(hhmm === w.end && !finestreProcessate[index]){
      finestreProcessate[index] = true;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${hhmm}</td>`;
      canali.forEach(c => c.subcanali.forEach(s => {
        const val = document.getElementById(`input_${c.id}_${s.id}`).value;
        tr.innerHTML += `<td>${val.replace(/\n/g,"<br>")}</td>`;
        document.getElementById(`input_${c.id}_${s.id}`).value = "";
      }));
      document.querySelector('#storici tbody').appendChild(tr);

      document.getElementById("alertSound").play();
      document.body.classList.add("flash");
      setTimeout(()=>document.body.classList.remove("flash"),2000);
    }
    if(hhmm !== w.end) {
      finestreProcessate[index] = false;
    }
  });
}

// --- Export ---
function clearStorici(){
  if(confirm("Eliminare tutta la tabella storici?")){
    document.querySelector("#storici tbody").innerHTML="";
  }
}

function exportCSV(){
  let csv="\ufeff";
  const header = Array.from(document.querySelectorAll('#storici th')).map(th=>th.textContent).join(";");
  csv+=header+"\n";
  document.querySelectorAll('#storici tbody tr').forEach(tr=>{
    const row=Array.from(tr.querySelectorAll('td')).map(td=>td.textContent.replace(/\n/g,"")).join(";");
    csv+=row+"\n";
  });
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="storici.csv";
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

function exportExcel(){
  const ws=XLSX.utils.table_to_sheet(document.getElementById('storici'));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Storici");
  XLSX.writeFile(wb,"storici.xlsx");
}

// --- Avvio iniziale ---
aggiungiCanale("Canale iniziale");
aggiornaHeaderStorici();
setInterval(aggiornaStorici,1000);
</script>
</body>
</html>


